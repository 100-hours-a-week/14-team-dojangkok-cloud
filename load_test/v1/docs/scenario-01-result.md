# 시나리오 1: 신규 사용자 온보딩 - 결과 분석

## 실행 정보

### 1차 실행 (2026-02-11)

| 항목 | 값 |
|------|-----|
| 실행 일시 | 2026-02-11 02:25:54 KST |
| 대상 서버 | https://<PRODUCTION_URL> |
| 테스트 시간 | 10분 3초 |
| 최대 VU | 100 |
| 토큰 방식 | 단일 토큰 (1개) |
| Rate Limit | **비활성화 상태** |
| 결과 파일 | `results/20260211_022554_scenario-1_summary.json` |

### 2차 실행 (2026-02-11, 닉네임 길이 수정 후)

| 항목 | 값 |
|------|-----|
| 실행 일시 | 2026-02-11 03:04:43 KST |
| 테스트 시간 | 10분 2초 |
| 최대 VU | 100 |
| Rate Limit | **비활성화 상태** |
| 결과 파일 | `results/20260211_030443_scenario-1_summary.json` |

### 3차 실행 (2026-02-12, NPE 수정 확인)

| 항목 | 값 |
|------|-----|
| 실행 일시 | 2026-02-12 16:43:05 KST |
| 대상 서버 | https://<PRODUCTION_URL> |
| 테스트 시간 | 10분 1초 |
| 최대 VU | 100 |
| 토큰 방식 | 단일 토큰 (1개) |
| Rate Limit | 활성화 상태 |
| 결과 파일 | `results/20260212_164305_scenario-1.json` |

---

## 요약

| 실행 | PATCH /members/nickname | POST /lifestyles | 원인 |
|------|------------------------|------------------|------|
| 1차 (02-11) | 100% 실패 (422) | 100% 실패 (401) | 닉네임 길이 초과 + DTO NPE |
| 2차 (02-11) | **100% 성공** | 100% 실패 (401) | DTO NPE (닉네임은 수정됨) |
| 3차 (02-12) | **100% 성공** | **54% 성공, 46% 실패 (401)** | NPE 수정됨, AI 서버 의존성 이슈 발견 |

- 1~2차에서 발견된 **DTO 역직렬화 NPE 버그는 수정 확인됨** (순차 호출 시 100% 성공)
- 3차에서 새로운 실패 원인 발견: 라이프스타일 생성 시 **AI 서버 후속 호출이 동시 부하에서 실패**
- 에러 페이지 → 401 마스킹 버그는 여전히 미수정 — AI 서버 오류도 401로 변환되어 k6에서 근본 원인 식별 불가

---

## 3차 실행 결과 (2026-02-12)

### Threshold 결과

| Threshold | 기준 | 실제 | 결과 |
|-----------|------|------|------|
| http_req_duration p(95) | < 3000ms | 153.47ms | **PASS** |
| http_req_duration p(99) | < 5000ms | 272.19ms | **PASS** |
| http_req_failed rate | < 5% | 22.71% | **FAIL** |
| PATCH /members/nickname p(95) | < 1000ms | 151.27ms | **PASS** |
| POST /lifestyles p(95) | < 5000ms | 156.43ms | **PASS** |

### 응답 시간

| API | avg | med | p(90) | p(95) | max |
|-----|-----|-----|-------|-------|-----|
| `PATCH /members/nickname` | 75.27ms | 65.61ms | 121.25ms | 151.27ms | 558.47ms |
| `POST /lifestyles` | 70.16ms | 56.76ms | 120.87ms | 156.43ms | 735.90ms |
| 전체 | 72.72ms | 60.90ms | 121.14ms | 153.47ms | 735.90ms |

### 처리량

| 지표 | 값 |
|------|-----|
| 총 요청 수 | 36,348 |
| 요청 속도 | 60.48 req/s |
| 이터레이션 속도 | 30.24 iter/s |
| 수신 데이터 | 19 MB (32 kB/s) |
| 송신 데이터 | 4.5 MB (7.5 kB/s) |

### Check 결과 상세

| Check | 성공 | 실패 | 성공률 |
|-------|------|------|--------|
| [닉네임설정] 상태 200/429 | 18,174 | 0 | **100%** |
| [라이프스타일생성] 상태 200/201/429 | 9,919 | 8,255 | 54.59% |

---

## 1~2차 실행 결과 (2026-02-11)

### 상태 코드 분포

#### 1차 실행 (닉네임 길이 수정 전, 체크리스트 템플릿 포함)

| API | 상태 코드 | 건수 | 비율 | 원인 |
|-----|-----------|------|------|------|
| `PATCH /members/nickname` | 422 | 13,609 | 100% | 닉네임 길이 초과 (`NICKNAME_TOO_LONG`) |
| `POST /lifestyles` | 401 | 13,609 | 100% | 서버 NPE → 401로 잘못 변환 |
| `GET /checklists/template` | 404 | 13,609 | 100% | 엔드포인트 미등록 |

#### 2차 실행 (닉네임 길이 수정 후, 체크리스트 템플릿 제거)

| API | 상태 코드 | 건수 | 비율 | 원인 |
|-----|-----------|------|------|------|
| `PATCH /members/nickname` | **200** | 18,985 | **100% 성공** | 닉네임 길이 수정 효과 확인 |
| `POST /lifestyles` | 401 | 18,985 | 100% | 서버 NPE → 401로 잘못 변환 |

### 2차 실행 응답 시간

| API | avg | med | p(90) | p(95) | max |
|-----|-----|-----|-------|-------|-----|
| `PATCH /members/nickname` (200) | 17.86ms | 16.33ms | 19.67ms | 21.76ms | 344.63ms |
| `POST /lifestyles` (401 에러) | 16.07ms | 14.37ms | 17.14ms | 18.93ms | 326.70ms |

---

## 분석

### 1. NPE 버그 수정 확인 (해결됨)

1~2차에서 `POST /lifestyles`가 100% 실패(401)했던 원인:

- 서버 측 DTO 역직렬화 실패로 인한 NPE 발생
- **3차 실행(02-12)에서 순차 호출 시 200 성공 확인 → 수정 완료**

### 2. 새로운 이슈: AI 서버 의존성 (미해결)

3차 실행에서 `POST /lifestyles`의 46% 실패 원인:

- 라이프스타일 생성 시 백엔드가 **AI 서버에 후속 요청**을 전송
- 동시 부하(100 VU) 상태에서 AI 서버 측 오류 발생
- 순차 호출 시에는 100% 성공, 동시 요청 시에만 실패 → **AI 서버의 동시 처리 한계**로 추정

### 3. `/error` → 401 마스킹 버그 (미해결)

이전에 식별된 문제가 여전히 존재합니다:

1. AI 서버 오류 → 백엔드에서 예외 발생
2. 글로벌 예외 핸들러에서 미처리 → 프레임워크가 에러 페이지로 포워딩
3. 에러 페이지가 인증 필수 정책에 포함되어 있음
4. 인증 실패 핸들러가 401 + 고정 메시지 반환

**결과**: k6 로그에서는 모든 실패가 동일한 401로 보여, AI 서버 타임아웃/에러/과부하 등 **구체적인 원인 식별이 불가능**합니다.

### 4. 닉네임 API 성능 (정상)

3차 실행에서 100 VU, 18,174건 전건 성공:

| 지표 | 2차 (02-11, RL OFF) | 3차 (02-12, RL ON) |
|------|--------------------|--------------------|
| avg | 17.86ms | 75.27ms |
| p(95) | 21.76ms | 151.27ms |
| 요청 속도 | 63 req/s | 60 req/s |
| 성공률 | 100% | 100% |

Rate Limit 활성화 상태에서 응답 시간이 증가했으나 안정적으로 동작합니다.

---

## 백엔드 팀 전달 사항

### ~~버그 1: DTO 역직렬화 실패~~ → 수정 완료

~~DTO에 기본 생성자 누락~~ → **2026-02-12 재실행에서 수정 확인됨**

### 버그 2: 에러 페이지 → 401 마스킹 (Medium, 미수정)

서버 내부 에러(500)가 401로 변환되어 디버깅이 어렵습니다.
에러 페이지 경로를 인증 없이 접근 가능하도록 보안 설정 수정이 필요합니다.

### 이슈 3: AI 서버 동시 부하 내성 (신규 발견)

라이프스타일 생성 시 AI 서버 호출이 동시 부하에서 실패합니다.
- 순차 호출: 100% 성공
- 동시 부하 (100 VU): 46% 실패
- 현재 에러 마스킹으로 인해 구체적 에러(타임아웃, 503, 커넥션 거부 등)를 식별할 수 없음
- **버그 2 수정 후 재실행하면 정확한 에러 원인 파악 가능**

### 권장: 인증 실패 메시지 개선 (Low)

현재 모든 인증 실패에 고정 메시지를 반환합니다. 실제 원인(만료, 무효, 누락 등)에 따라 메시지를 분기하면 디버깅이 용이해집니다.

---

## 시나리오 스크립트 수정 이력

| 수정 사항 | 파일 | 내용 |
|-----------|------|------|
| 닉네임 길이 수정 | `scenario-01-new-user-onboarding.js` | `user_${vuId}_${iterId}_${Date.now()}` → `u${vuId}_${iterId}` |
| 체크리스트 템플릿 제거 | `scenario-01-new-user-onboarding.js` | 실제 온보딩 플로우에 포함되지 않아 제거 |
| 라이프스타일 요청 키 수정 | `helpers.js` | `lifestyleItemList` → `lifestyle_items` (API 필드명과 일치) |

## 다음 단계

1. **백엔드**: 에러 페이지 경로를 인증 없이 접근 가능하도록 보안 설정 수정 → 재배포
2. **백엔드**: AI 서버 호출 에러 핸들링 개선 (타임아웃, 재시도, 서킷브레이커 등)
3. 수정 배포 후 시나리오 1 재실행 → 정확한 에러 원인 파악 및 온보딩 전체 성능 데이터 확보
