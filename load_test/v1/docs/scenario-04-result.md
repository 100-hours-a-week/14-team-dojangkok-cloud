# 시나리오 4: 파일 업로드 - 결과 분석

## 시나리오 04a: 집 노트 파일 업로드

### 실행 정보

#### 1차 실행 (수정 전, 400 VU)

| 항목 | 값 |
|------|-----|
| 실행 일시 | 2026-02-11 18:05:52 KST |
| 대상 서버 | https://<PRODUCTION_URL> |
| 테스트 시간 | ~10분 |
| 최대 VU | 400 |
| 토큰 방식 | 단일 토큰 (1개) |
| Rate Limit | **비활성화 상태** |
| 결과 파일 | `results/20260211_180552_scenario-04a_summary.json` |

> API 경로 오류로 Presigned URL 발급이 100% 실패 → 경로 수정 후 재실행

#### 최종 실행 (수정 후, 400 VU)

| 항목 | 값 |
|------|-----|
| 실행 일시 | 2026-02-11 18:27:05 KST |
| 대상 서버 | https://<PRODUCTION_URL> |
| 테스트 시간 | 10분 2초 |
| 최대 VU | 400 |
| 토큰 방식 | 단일 토큰 (1개) |
| Rate Limit | **비활성화 상태** |
| 결과 파일 | `results/20260211_182705_scenario-04a_summary.json` |

### 요약

1차에서 API 경로 오류(`/file-assets/presigned-urls` → `/home-notes/{id}/files/presigned-urls`)로 Presigned URL 발급이 100% 실패하여, 경로 수정 후 최종 실행하였습니다.

**최종 실행: 전체 파이프라인 정상 동작, 에러율 0.017%.** 2개 개별 Threshold 초과 외 전 구간 안정적.

- 총 요청: **122,712건** (19,416 iterations)
- 처리량: **203.86 req/s**
- 에러율: **0.017%** (S3 업로드 21건 타임아웃)
- 전체 check 성공율: **99.99%** (142,107/142,128)
- 이터레이션당 API 호출: ~6.3건 (생성 1 + presigned 1 + S3 업로드 1~2 + complete 1 + 첨부 1 + 삭제 1)

### Threshold 결과 (최종)

| Threshold | 기준 | 실제 | 결과 |
|-----------|------|------|------|
| http_req_duration p(95) | < 3000ms | 2,570ms | **PASS** |
| http_req_duration p(99) | < 5000ms | - | **PASS** |
| http_req_failed rate | < 5% | 0.017% | **PASS** |
| POST /home-notes/{id}/files/presigned-urls p(95) | < 3000ms | 2,038ms | **PASS** |
| PUT S3 presigned-upload p(95) | < 10000ms | 129ms | **PASS** |
| POST /home-notes/files/complete p(95) | < 2000ms | 3,627ms | **FAIL** |
| POST /home-notes/{id}/files p(95) | < 2000ms | 2,037ms | **FAIL** |

### 응답 시간 (최종)

#### 전체 종합

| 지표 | 값 |
|------|-----|
| avg | 1,186ms |
| med | 1,400ms |
| p(90) | 2,153ms |
| p(95) | 2,570ms |
| max | 7,173ms |

#### API별 응답 시간

| API | avg | med | p(90) | p(95) | max |
|-----|-----|-----|-------|-------|-----|
| `POST /home-notes/{id}/files/presigned-urls` | 1,351ms | 1,541ms | 1,920ms | 2,038ms | 5,100ms |
| `PUT S3 presigned-upload` | 60ms | 48ms | 112ms | 129ms | 351ms |
| `POST /home-notes/files/complete` | 2,074ms | 2,165ms | 3,113ms | 3,627ms | 7,000ms |
| `POST /home-notes/{id}/files` (첨부) | 1,332ms | 1,493ms | 1,923ms | 2,037ms | 7,173ms |

#### 처리량

| 지표 | 값 |
|------|-----|
| 총 요청 수 | 122,712 |
| 요청 속도 | 203.86 req/s |
| 이터레이션 속도 | 32.26 iter/s |
| 수신 데이터 | 315 MB (535 kB/s) |
| 송신 데이터 | 330 MB (562 kB/s) |

#### 요청 분포

| API | 요청 수 | 비고 |
|-----|---------|------|
| POST /home-notes | 19,416 | 이터레이션당 1회 |
| POST /home-notes/{id}/files/presigned-urls | 19,416 | 이터레이션당 1회 |
| PUT S3 presigned-upload | 25,674 | 프리셋에 따라 1~2회 |
| POST /home-notes/files/complete | 19,416 | 이터레이션당 1회 |
| POST /home-notes/{id}/files | 19,395 | S3 실패 21건 제외 |
| DELETE /home-notes/{id} | 19,416 | 이터레이션당 1회 |

#### Check 상세

| 체크 | 통과 | 실패 |
|------|------|------|
| [집노트생성] 상태 200/201/429 | 19,416 | 0 |
| [집노트생성] home_note_id 존재 | 19,416 | 0 |
| [집노트PresignedURL] 상태 200/201/429 | 19,416 | 0 |
| [S3업로드] 상태 200 | 25,653 | **21** |
| [집노트파일업로드완료] 상태 200/201/429 | 19,395 | 0 |
| [집노트파일첨부] 상태 200/201/429 | 19,395 | 0 |
| [집노트삭제] 상태 204/429 | 19,416 | 0 |

> S3 업로드 21건 실패는 네트워크 연결 리셋(EOF)으로 인한 것으로, 전체 0.08%에 해당하여 무시 가능.

---

## 시나리오 04b: 쉬운 계약서 파일 업로드 (OCR 포함)

### 실행 정보

| 항목 | 값 |
|------|-----|
| 실행 일시 | 2026-02-11 18:27:05 KST (04a 직후) |
| 대상 서버 | https://<PRODUCTION_URL> |
| 테스트 시간 | 10분 11초 |
| 최대 VU | 10 |
| 토큰 방식 | 단일 토큰 (1개) |
| Rate Limit | **비활성화 상태** |
| 결과 파일 | `results/20260211_182705_scenario-04b_summary.json` |

### 요약

**파일 업로드 파이프라인 자체는 정상이나, OCR 계약서 생성에서 87.5% 실패 (502 Bad Gateway).**

- 총 요청: **1,728건** (367 iterations)
- 처리량: **2.83 req/s**
- 에러율: **18.6%** (321건 502 Bad Gateway)
- 전체 check 성공율: **81.4%** (1,407/1,728)
- 성공 계약서 생성: **46건** (분당 약 4.6건 처리)

### Threshold 결과

| Threshold | 기준 | 실제 | 결과 |
|-----------|------|------|------|
| http_req_duration p(95) | < 3000ms | 363ms | **PASS** |
| http_req_duration p(99) | < 5000ms | - | **FAIL** |
| http_req_failed rate | < 5% | 18.6% | **FAIL** |
| POST /easy-contracts/files/presigned-urls p(95) | < 3000ms | 113ms | **PASS** |
| PUT S3 presigned-upload p(95) | < 10000ms | 125ms | **PASS** |
| POST /easy-contracts/files/complete p(95) | < 2000ms | 136ms | **PASS** |
| POST /easy-contracts p(95) | < 60000ms | 45,622ms | **PASS** |

### 응답 시간

#### 전체 종합

| 지표 | 값 |
|------|-----|
| avg | 2,000ms |
| med | 51ms |
| p(90) | 195ms |
| p(95) | 363ms |
| max | 76,582ms |

> avg(2,000ms)와 med(51ms)의 큰 괴리는 OCR 처리 응답(수십 초)이 평균을 끌어올리기 때문.

#### API별 응답 시간

| API | avg | med | p(90) | p(95) | max |
|-----|-----|-----|-------|-------|-----|
| `POST /easy-contracts/files/presigned-urls` | 1,348ms | 27ms | 99ms | 113ms | 49,179ms |
| `PUT S3 presigned-upload` | 56ms | 44ms | 101ms | 125ms | 172ms |
| `POST /easy-contracts/files/complete` | 64ms | 52ms | 124ms | 136ms | 165ms |
| `POST /easy-contracts` (OCR) | 7,779ms | 188ms | 30,187ms | 45,622ms | 76,582ms |

> Presigned URL의 avg(1,348ms)와 med(27ms) 괴리도 일부 요청이 서버 큐 대기로 지연된 것.

#### 처리량

| 지표 | 값 |
|------|-----|
| 총 요청 수 | 1,728 |
| 요청 속도 | 2.83 req/s |
| 이터레이션 속도 | 0.60 iter/s |
| 수신 데이터 | 3.7 MB |
| 송신 데이터 | 6.9 MB |

#### Check 상세

| 체크 | 통과 | 실패 |
|------|------|------|
| [쉬운계약서PresignedURL] 상태 200/201/429 | 367 | 0 |
| [S3업로드] 상태 200 | 581 | 0 |
| [쉬운계약서파일업로드완료] 상태 200/201/429 | 367 | 0 |
| **[쉬운계약서생성] 상태 200/201/429/500** | **46** | **321** |
| [쉬운계약서삭제] 상태 204/200/429 | 46 | 0 |

### OCR 실패 상세 분석

321건 전부 **502 Bad Gateway** 반환 (체크 조건 200/201/429/500에 해당하지 않음).

#### 502 응답 패턴

| 유형 | 건수 | 비율 | 응답시간 | 원인 |
|------|------|------|----------|------|
| 즉시 거절 | 293건 | 91.3% | 91~372ms (median 181ms) | 리버스 프록시가 업스트림 연결 실패/큐 포화로 즉시 502 반환 |
| 업스트림 타임아웃 | 28건 | 8.7% | 30~50초 | 요청이 업스트림에 도달했으나 프록시 타임아웃(~30초) 초과 |

#### 성공 요청(200) 특성

- 46건 성공, 전부 **22~76초** 소요 (avg 39.7초)
- 10분간 46건 처리 = **분당 약 4.6건** 처리 용량

#### 시간대별 502 비율

| 시간 | 200 | 502 | 합계 | 502 비율 |
|------|-----|-----|------|----------|
| 18:38 | 2 | 17 | 19 | 89% |
| 18:39 | 4 | 18 | 22 | 82% |
| 18:40 | 5 | 11 | 16 | 69% |
| 18:41 | 2 | 33 | 35 | 94% |
| 18:42 | 6 | 29 | 35 | 83% |
| 18:43 | 7 | 60 | 67 | 90% |
| 18:44 | 4 | 62 | 66 | 94% |
| 18:45 | 7 | 58 | 65 | 89% |
| 18:46 | 6 | 26 | 32 | 81% |
| 18:47 | 3 | 7 | 10 | 70% |

> 전 구간에서 일관적으로 70~94% 실패 → 서버 워커 포화 상태가 지속.

---

## 분석

### 1. 04a 파일 업로드 파이프라인 성능

| 구간 | avg | p(95) | 상태 |
|------|-----|-------|------|
| Presigned URL 발급 | 1,351ms | 2,038ms | 양호 |
| S3 업로드 | 60ms | 129ms | **매우 빠름** |
| 업로드 완료 처리 | 2,074ms | 3,627ms | **병목** |
| 파일 첨부 | 1,332ms | 2,037ms | 경계 |

- **S3 업로드**는 가장 빠른 구간 (p95 129ms) — 외부 서비스임에도 안정적
- **업로드 완료 처리**(`/home-notes/files/complete`)가 최대 병목: p(95) 3,627ms로 threshold(2,000ms) 대비 **1.8배 초과**
- **파일 첨부**(`/home-notes/{id}/files`)도 p(95) 2,037ms로 threshold(2,000ms)을 소폭 초과
- 전체 파이프라인 p(95) 2,570ms는 3,000ms 기준 내로 **전체적으로는 안정적**

### 2. 04b OCR 처리 한계

- OCR 처리는 **1건당 22~76초**(avg 39.7초)가 소요되는 CPU/GPU 집약적 작업
- 동시 처리 용량이 극히 제한적이며, 10 VU에서도 **87.5% 실패**
- 파일 업로드 파이프라인(presigned URL → S3 → complete) 자체는 **100% 성공** → OCR만 병목
- 서버의 실제 OCR 처리 용량: **분당 약 4.6건**
- 502 응답의 91.3%가 즉시 거절 → 리버스 프록시 단에서 업스트림 큐 포화로 차단

### 3. 04a vs 시나리오 3 비교

| 지표 | 시나리오 3 (CRUD, 400 VU) | 시나리오 04a (파일 업로드, 400 VU) |
|------|--------------------------|----------------------------------|
| API 유형 | CRUD (POST/PATCH/GET/DELETE) | 파일 업로드 (Presigned + S3 + 후처리) |
| 에러율 | ~0% | 0.017% |
| avg 응답 시간 | 702ms | 1,186ms |
| p(95) 응답 시간 | 969ms | 2,570ms |
| 요청 속도 | 200 req/s | 204 req/s |
| Threshold 결과 | 전체 PASS | 2개 FAIL |

> 파일 업로드는 CRUD 대비 응답 시간이 약 **2.7배** 느림 (p95 기준). S3 연동 및 파일 후처리가 주요 원인.

### 4. 송수신 데이터량

| 시나리오 | 수신 | 송신 | 비고 |
|----------|------|------|------|
| 시나리오 3 (400 VU) | 126 MB | 11 MB | CRUD (텍스트 위주) |
| 04a (400 VU) | 315 MB | 330 MB | 파일 업로드 (바이너리 포함) |
| 04b (10 VU) | 3.7 MB | 6.9 MB | 소량 (VU 10개) |

> 04a는 바이너리 파일 전송으로 인해 **송신 데이터가 수신보다 많은** 특이한 패턴.

### 5. 결론

- **04a (집 노트 파일 업로드)**: 400 VU에서 전체 파이프라인 정상 동작. `files/complete`와 `files` 첨부 API의 threshold 완화 또는 백엔드 최적화 필요
  - `files/complete` threshold를 **4,000ms로 완화**하면 전체 PASS 가능
  - `files` 첨부 threshold를 **2,500ms로 완화**하면 PASS 가능
- **04b (쉬운 계약서 OCR)**: 현재 동기 처리 방식으로는 동시 부하 처리 불가. **비동기 처리 전환 필수**

---

## 수정 이력 (테스트 중 발견 및 수정)

| 실행 | 문제 | 수정 내용 |
|------|------|-----------|
| 1차 (15:23) | API 경로 오류 → Presigned URL 100% 실패 | `/file-assets/presigned-urls` → `/home-notes/{id}/files/presigned-urls` |
| 중간 (18:05) | 응답 필드 매핑 오류 → 파일 첨부 실패 | `data.file_items` → `data.success_file_items` |
| 중간 | k6 런타임 호환성 | `length` → `byteLength`, `content_type` → `file_key` 판별 |
| 중간 | run-04ab.sh 인증 오류 | stderr 리다이렉트, refresh token rotation 파일 기반 전환 |
| 최종 (18:27) | 전체 수정 반영 후 정상 실행 | - |

## 개선 권장 사항

### 서버 측

1. **OCR 비동기 처리 전환** (Critical): `POST /easy-contracts`를 요청 접수 → 폴링/웹훅으로 결과 조회하는 비동기 방식으로 전환. 현재 동기 방식은 1건당 22~76초 소요되어 동시 처리 불가.
2. **리버스 프록시 타임아웃 조정**: OCR 엔드포인트의 프록시 타임아웃을 최소 120초로 설정 (현재 ~30초로 추정).
3. **files/complete 응답 최적화**: 400 VU에서 p95=3.6초까지 증가하므로 DB 쿼리 또는 후처리 로직 점검 필요.

### 테스트 측

1. **OCR 시나리오 재설계**: `constant-arrival-rate` executor로 분당 3~4건 수준으로 요청률 제어하여 실제 서버 용량에 맞는 부하 측정.
2. **04a VU 단계별 테스트**: 200/300/400 VU 구간별 테스트로 `files/complete` 병목의 임계점 확인.

## 다음 단계

1. 백엔드에서 `files/complete` 응답 시간 최적화
2. OCR 비동기 처리 전환 후 04b 재실행
3. 시나리오 04a 확정 VU: **400** (전체 파이프라인 정상, 개별 threshold 완화 검토)
4. 시나리오 04b 확정 VU: 비동기 전환 후 재결정 필요
