# 시나리오 1: 신규 사용자 온보딩 - 점검 기록

## 목적

카카오 소셜 로그인 특성상 대규모 회원가입 부하 테스트는 불가하므로,
**가입 후 온보딩 API(닉네임 설정 / 라이프스타일 등록)**의 부하를 측정한다.

측정 목표:
- 온보딩 API 2종의 응답 시간(p95, p99) 확인
- AI 서버 의존성(라이프스타일 생성 시 후속 호출)에 대한 동시 부하 내성 확인

## 테스트 흐름

```
[토큰 준비] → 닉네임 설정(PATCH) → sleep(0.5s) → 라이프스타일 등록(POST) → sleep(2s)
```

### API 호출 상세

| 순서 | API | 메서드 | 설명 |
|------|-----|--------|------|
| 1 | `/api/v1/members/nickname` | PATCH | 닉네임 설정 (`u{vuId}_{iterId}`) |
| 2 | `/api/v1/lifestyles` | POST | 라이프스타일 등록 (5개 프리셋 중 VU ID 기반 선택) |

### 부하 프로파일 (ramping-vus)

| 단계 | 시간 | VU 수 | 설명 |
|------|------|-------|------|
| Ramp-up | 2분 | 0 → 100 | 점진적 증가 |
| Steady | 6분 | 100 | 최대 부하 유지 |
| Ramp-down | 2분 | 100 → 0 | 점진적 감소 |

총 테스트 시간: **10분**, gracefulRampDown: 30s

## 특이사항

- **AI 서버 의존성**: `POST /lifestyles` 호출 시 백엔드가 AI 서버에 후속 요청을 전송 → 동시 부하에서 실패 가능성 존재
- **에러 페이지 → 401 마스킹 버그**: 서버 내부 에러가 에러 페이지 포워딩을 거쳐 401로 변환됨 → k6에서 근본 원인 식별 불가
- Rate Limit **비활성화 상태**에서 테스트 (단일 토큰 사용으로 인한 제약)

## 한계점

### 1. 단일 토큰 사용의 제약
- 카카오 소셜 로그인 구조상 다수의 독립 계정 토큰을 자동 생성할 수 없음
- 단일 토큰으로 100 VU 실행 → 동일 사용자에 대한 동시 요청으로 실제 다중 사용자 시나리오와 차이 있음

### 2. 실제 온보딩 시뮬레이션과의 차이
- 실제로는 각 사용자가 개별 토큰을 갖지만, 테스트에서는 동일 토큰 공유
- 닉네임 설정이 동일 사용자에게 반복 적용되므로 서버 측 동작이 실제와 다를 수 있음
- 라이프스타일 등록도 동일 사용자에게 반복 → 업데이트로 처리될 가능성

## 성공 기준 (thresholds)

| 지표 | 기준 |
|------|------|
| 전체 http_req_duration p(95) | < 3000ms |
| 전체 http_req_duration p(99) | < 5000ms |
| http_req_failed rate | < 5% |
| PATCH /members/nickname p(95) | < 1000ms |
| POST /lifestyles p(95) | < 5000ms |

## 실행 조건

### 실행 명령

```bash
# 단일 토큰 사용
ACCESS_TOKEN=<토큰> ./run.sh 1

# 토큰 풀 사용 (tokens.json 또는 환경변수)
ACCESS_TOKENS="token1,token2,token3" ./run.sh 1
```

### 참고: 토큰 만료
- access token 유효기간: 30분
- 테스트 총 시간 10분이므로 단일 실행 시 만료 문제 없음
- 연속 실행 시 토큰 재발급 필요

## 수정 이력 (테스트 중 발견)

### 스크립트 수정

| 수정 사항 | 내용 |
|-----------|------|
| 닉네임 길이 수정 | `user_{vuId}_{iterId}_{timestamp}` → `u{vuId}_{iterId}` (닉네임 길이 초과 422 해결) |
| 체크리스트 템플릿 제거 | 1차 실행에서 404 반환 → 실제 온보딩 플로우에 포함되지 않아 제거 |
| 라이프스타일 요청 키 수정 | `lifestyleItemList` → `lifestyle_items` (API 필드명과 일치) |

### 서버 측 수정 확인

| 항목 | 상태 | 내용 |
|------|------|------|
| DTO 역직렬화 NPE | **수정됨** | DTO 기본 생성자 누락 → 추가, 3차 실행(02-12)에서 순차 호출 100% 성공 확인 |
| 에러 페이지 → 401 마스킹 | **미수정** | 에러 페이지 경로를 인증 없이 접근 가능하도록 보안 설정 수정 필요 |
| AI 서버 동시 부하 내성 | **미해결** | 동시 부하(100 VU)에서 라이프스타일 46% 실패, 순차 호출 시 100% 성공 |
